{"title":"学习ahooks之useLongPress","slug":"学习ahooks之useLongPress","date":"2023-03-17T19:23:09.000Z","updated":"2023-05-12T11:12:45.236Z","comments":true,"path":"api/articles/学习ahooks之useLongPress.json","excerpt":null,"covers":null,"content":"<h1 id=\"缘由\"><a href=\"#缘由\" class=\"headerlink\" title=\"缘由\"></a>缘由</h1><p>可能是小程序api用多了，前几天写网页有个需求是监听长按，竟然有点生疏，幸好ahooks实现了useLongPress这个hook。</p>\n<h1 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h1><p><a href=\"https://github.com/alibaba/hooks/blob/master/packages/hooks/src/useLongPress/index.ts\">原版代码</a></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> touchSupported =</span><br><span class=\"line\">  isBrowser &amp;&amp;</span><br><span class=\"line\">  <span class=\"comment\">// @ts-ignore</span></span><br><span class=\"line\">  (<span class=\"string\">&#x27;ontouchstart&#x27;</span> <span class=\"keyword\">in</span> <span class=\"variable language_\">window</span> || (<span class=\"variable language_\">window</span>.<span class=\"property\">DocumentTouch</span> &amp;&amp; <span class=\"variable language_\">document</span> <span class=\"keyword\">instanceof</span> <span class=\"title class_\">DocumentTouch</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">useLongPress</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">  onLongPress: (event: EventType) =&gt; <span class=\"keyword\">void</span>,</span></span><br><span class=\"line\"><span class=\"params\">  target: BasicTarget,</span></span><br><span class=\"line\"><span class=\"params\">  &#123; delay = <span class=\"number\">300</span>, moveThreshold, onClick, onLongPressEnd &#125;: Options = &#123;&#125;,</span></span><br><span class=\"line\"><span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> onLongPressRef = <span class=\"title function_\">useLatest</span>(onLongPress);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> onClickRef = <span class=\"title function_\">useLatest</span>(onClick);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> onLongPressEndRef = <span class=\"title function_\">useLatest</span>(onLongPressEnd);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> timerRef = useRef&lt;<span class=\"title class_\">ReturnType</span>&lt;<span class=\"keyword\">typeof</span> <span class=\"built_in\">setTimeout</span>&gt;&gt;();</span><br><span class=\"line\">  <span class=\"keyword\">const</span> isTriggeredRef = <span class=\"title function_\">useRef</span>(<span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> pervPositionRef = <span class=\"title function_\">useRef</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">0</span>, <span class=\"attr\">y</span>: <span class=\"number\">0</span> &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> hasMoveThreshold = !!(</span><br><span class=\"line\">    (moveThreshold?.<span class=\"property\">x</span> &amp;&amp; moveThreshold.<span class=\"property\">x</span> &gt; <span class=\"number\">0</span>) ||</span><br><span class=\"line\">    (moveThreshold?.<span class=\"property\">y</span> &amp;&amp; moveThreshold.<span class=\"property\">y</span> &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">useEffectWithTarget</span>(</span><br><span class=\"line\">    <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> targetElement = <span class=\"title function_\">getTargetElement</span>(target);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!targetElement?.<span class=\"property\">addEventListener</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">overThreshold</span> = (<span class=\"params\">event: EventType</span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> &#123; clientX, clientY &#125; = <span class=\"title function_\">getClientPosition</span>(event);</span><br><span class=\"line\">        <span class=\"keyword\">const</span> offsetX = <span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(clientX - pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"keyword\">const</span> offsetY = <span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(clientY - pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">y</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> !!(</span><br><span class=\"line\">          (moveThreshold?.<span class=\"property\">x</span> &amp;&amp; offsetX &gt; moveThreshold.<span class=\"property\">x</span>) ||</span><br><span class=\"line\">          (moveThreshold?.<span class=\"property\">y</span> &amp;&amp; offsetY &gt; moveThreshold.<span class=\"property\">y</span>)</span><br><span class=\"line\">        );</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">function</span> <span class=\"title function_\">getClientPosition</span>(<span class=\"params\">event: EventType</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (event <span class=\"keyword\">instanceof</span> <span class=\"title class_\">TouchEvent</span>) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">clientX</span>: event.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">clientY</span>: event.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span>,</span><br><span class=\"line\">          &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (event <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MouseEvent</span>) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">clientX</span>: event.<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">clientY</span>: event.<span class=\"property\">clientY</span>,</span><br><span class=\"line\">          &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">warn</span>(<span class=\"string\">&#x27;Unsupported event type&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123; <span class=\"attr\">clientX</span>: <span class=\"number\">0</span>, <span class=\"attr\">clientY</span>: <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span> = (<span class=\"params\">event: EventType</span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> &#123; clientX, clientY &#125; = <span class=\"title function_\">getClientPosition</span>(event);</span><br><span class=\"line\">          pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">x</span> = clientX;</span><br><span class=\"line\">          pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">y</span> = clientY;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        timerRef.<span class=\"property\">current</span> = <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          onLongPressRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">          isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;, delay);</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span> = (<span class=\"params\">event: TouchEvent</span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span> &amp;&amp; <span class=\"title function_\">overThreshold</span>(event)) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">clearInterval</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">          timerRef.<span class=\"property\">current</span> = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span> = (<span class=\"params\">event: EventType, shouldTriggerClick: boolean = <span class=\"literal\">false</span></span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isTriggeredRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          onLongPressEndRef.<span class=\"property\">current</span>?.(event);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (shouldTriggerClick &amp;&amp; !isTriggeredRef.<span class=\"property\">current</span> &amp;&amp; onClickRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          onClickRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onEndWithClick</span> = (<span class=\"params\">event: EventType</span>) =&gt; <span class=\"title function_\">onEnd</span>(event, <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">          isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    [],</span><br><span class=\"line\">    target,</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>先忽略种种细节，useLongPress这个函数接收三个参数：</p>\n<ol>\n<li>onLongPress，顾名思义，触发长按事件的回调函数。</li>\n<li>target：可以是dom元素，也可以是存储dom元素的ref。</li>\n<li>第三个参数是个对象，有四个子参数：delay(长按多长时间以后触发长按事件，也就是触发长按事件的时间)、moveThreshold（在长按的过程中鼠标或者手指如果有移动，并且这个值存在，会根据这个参数的值决定是否响应长按事件）、onClick(如果有这个值，并且鼠标或者手指按压结束，并且按压时间小于delay，会调用onClick函数)、onLongPressEnd(如果按压结束已经触发过长按事件，在真正结束的时候如果有这个值会调用onLongPressEnd函数)。</li>\n</ol>\n<p>代码开头那个useEffectWithTarget先认为就是useEffect，先忽略useEffectWithTarget大多数代码，直接看这几句：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">        isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>根据是否支持触摸事件，分别监听鼠标或者touch事件，响应的事件很有规律，只不过鼠标事件多了个mouseleave，这里我觉得touch事件也应该加个对应的，比如touchcancel。</p>\n<p>onStart</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span> = (<span class=\"params\">event: EventType</span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasMoveThreshold) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> &#123;clientX, clientY&#125; = <span class=\"title function_\">getClientPosition</span>(event);</span><br><span class=\"line\">        pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">x</span> = clientX;</span><br><span class=\"line\">        pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">y</span> = clientY;</span><br><span class=\"line\">    &#125; <span class=\"comment\">// 假设没有moveThreshold，这一句先忽略</span></span><br><span class=\"line\">    timerRef.<span class=\"property\">current</span> = <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        onLongPressRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">        isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;, delay); <span class=\"comment\">//delay秒后执行onLongPressRef.current，isTriggeredRef.current表示是否执行过onLongPress</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>onEndWithClick</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onEndWithClick</span> = (<span class=\"params\">event: EventType</span>) =&gt; <span class=\"title function_\">onEnd</span>(event, <span class=\"literal\">true</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span> = (<span class=\"params\">event: EventType, shouldTriggerClick: boolean = <span class=\"literal\">false</span></span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>); <span class=\"comment\">//鼠标抬起或者触摸结束时，如果onLongPress还没有调用，清除定时器</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isTriggeredRef.<span class=\"property\">current</span>) &#123; <span class=\"comment\">//如果onLongPress已经被调用过了，调用onLongPressEnd（如果有）</span></span><br><span class=\"line\">        onLongPressEndRef.<span class=\"property\">current</span>?.(event);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (shouldTriggerClick &amp;&amp; !isTriggeredRef.<span class=\"property\">current</span> &amp;&amp; onClickRef.<span class=\"property\">current</span>) &#123; </span><br><span class=\"line\">        onClickRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">    &#125; <span class=\"comment\">// 这里的shouldTriggerClick为true，如果onLongPress还没有被触发并且有onClick，调用onClick</span></span><br><span class=\"line\">    isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>onStart与onEndWithClick其实就是onLongPress函数的核心。有时候按压的时候会移动，这时候是否触发longpress事件，这种情况就需要传moveThreshold。</p>\n<p>这个值是个对象{x:0,y:0}，如果按压的过程中有移动，移动的距离(x&#x2F;y)大于moveThreshold.x或者moveThreshold.y，就会取消响应longPress。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span> = (<span class=\"params\">event: TouchEvent</span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span> &amp;&amp; <span class=\"title function_\">overThreshold</span>(event)) &#123; <span class=\"comment\">//移动的时候还没有响应longPress，并且移动的距离超了，就会取消定时器</span></span><br><span class=\"line\">        <span class=\"built_in\">clearInterval</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">        timerRef.<span class=\"property\">current</span> = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>以上就是useLongPress的主要内容。</p>\n<h2 id=\"useEffectWithTarget\"><a href=\"#useEffectWithTarget\" class=\"headerlink\" title=\"useEffectWithTarget\"></a>useEffectWithTarget</h2><p>这里顺便提一下这个hook，代码在<a href=\"https://github.com/alibaba/hooks/blob/master/packages/hooks/src/utils/createEffectWithTarget.ts\">这里</a>，看起来功能和useEffect差不多，只不过多了对前后dom元素的对比，<a href=\"https://github.com/alibaba/hooks/blob/master/packages/hooks/src/utils/createEffectWithTarget.ts#L42\">代码</a>，参数也由useEffect的两个变成了三个。我觉得这个hook的意义更多的在于代码的可读性，由于第三个参数的存在，可以明确表示这个hook是与哪个dom元素相关联。</p>\n","more":"<h1 id=\"缘由\"><a href=\"#缘由\" class=\"headerlink\" title=\"缘由\"></a>缘由</h1><p>可能是小程序api用多了，前几天写网页有个需求是监听长按，竟然有点生疏，幸好ahooks实现了useLongPress这个hook。</p>\n<h1 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h1><p><a href=\"https://github.com/alibaba/hooks/blob/master/packages/hooks/src/useLongPress/index.ts\">原版代码</a></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> touchSupported =</span><br><span class=\"line\">  isBrowser &amp;&amp;</span><br><span class=\"line\">  <span class=\"comment\">// @ts-ignore</span></span><br><span class=\"line\">  (<span class=\"string\">&#x27;ontouchstart&#x27;</span> <span class=\"keyword\">in</span> <span class=\"variable language_\">window</span> || (<span class=\"variable language_\">window</span>.<span class=\"property\">DocumentTouch</span> &amp;&amp; <span class=\"variable language_\">document</span> <span class=\"keyword\">instanceof</span> <span class=\"title class_\">DocumentTouch</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">useLongPress</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">  onLongPress: (event: EventType) =&gt; <span class=\"keyword\">void</span>,</span></span><br><span class=\"line\"><span class=\"params\">  target: BasicTarget,</span></span><br><span class=\"line\"><span class=\"params\">  &#123; delay = <span class=\"number\">300</span>, moveThreshold, onClick, onLongPressEnd &#125;: Options = &#123;&#125;,</span></span><br><span class=\"line\"><span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> onLongPressRef = <span class=\"title function_\">useLatest</span>(onLongPress);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> onClickRef = <span class=\"title function_\">useLatest</span>(onClick);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> onLongPressEndRef = <span class=\"title function_\">useLatest</span>(onLongPressEnd);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> timerRef = useRef&lt;<span class=\"title class_\">ReturnType</span>&lt;<span class=\"keyword\">typeof</span> <span class=\"built_in\">setTimeout</span>&gt;&gt;();</span><br><span class=\"line\">  <span class=\"keyword\">const</span> isTriggeredRef = <span class=\"title function_\">useRef</span>(<span class=\"literal\">false</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> pervPositionRef = <span class=\"title function_\">useRef</span>(&#123; <span class=\"attr\">x</span>: <span class=\"number\">0</span>, <span class=\"attr\">y</span>: <span class=\"number\">0</span> &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> hasMoveThreshold = !!(</span><br><span class=\"line\">    (moveThreshold?.<span class=\"property\">x</span> &amp;&amp; moveThreshold.<span class=\"property\">x</span> &gt; <span class=\"number\">0</span>) ||</span><br><span class=\"line\">    (moveThreshold?.<span class=\"property\">y</span> &amp;&amp; moveThreshold.<span class=\"property\">y</span> &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">  );</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">useEffectWithTarget</span>(</span><br><span class=\"line\">    <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> targetElement = <span class=\"title function_\">getTargetElement</span>(target);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!targetElement?.<span class=\"property\">addEventListener</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">overThreshold</span> = (<span class=\"params\">event: EventType</span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> &#123; clientX, clientY &#125; = <span class=\"title function_\">getClientPosition</span>(event);</span><br><span class=\"line\">        <span class=\"keyword\">const</span> offsetX = <span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(clientX - pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"keyword\">const</span> offsetY = <span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(clientY - pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">y</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> !!(</span><br><span class=\"line\">          (moveThreshold?.<span class=\"property\">x</span> &amp;&amp; offsetX &gt; moveThreshold.<span class=\"property\">x</span>) ||</span><br><span class=\"line\">          (moveThreshold?.<span class=\"property\">y</span> &amp;&amp; offsetY &gt; moveThreshold.<span class=\"property\">y</span>)</span><br><span class=\"line\">        );</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">function</span> <span class=\"title function_\">getClientPosition</span>(<span class=\"params\">event: EventType</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (event <span class=\"keyword\">instanceof</span> <span class=\"title class_\">TouchEvent</span>) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">clientX</span>: event.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">clientY</span>: event.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span>,</span><br><span class=\"line\">          &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (event <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MouseEvent</span>) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">clientX</span>: event.<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">clientY</span>: event.<span class=\"property\">clientY</span>,</span><br><span class=\"line\">          &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">warn</span>(<span class=\"string\">&#x27;Unsupported event type&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123; <span class=\"attr\">clientX</span>: <span class=\"number\">0</span>, <span class=\"attr\">clientY</span>: <span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span> = (<span class=\"params\">event: EventType</span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> &#123; clientX, clientY &#125; = <span class=\"title function_\">getClientPosition</span>(event);</span><br><span class=\"line\">          pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">x</span> = clientX;</span><br><span class=\"line\">          pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">y</span> = clientY;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        timerRef.<span class=\"property\">current</span> = <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          onLongPressRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">          isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;, delay);</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span> = (<span class=\"params\">event: TouchEvent</span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span> &amp;&amp; <span class=\"title function_\">overThreshold</span>(event)) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">clearInterval</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">          timerRef.<span class=\"property\">current</span> = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span> = (<span class=\"params\">event: EventType, shouldTriggerClick: boolean = <span class=\"literal\">false</span></span>) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isTriggeredRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          onLongPressEndRef.<span class=\"property\">current</span>?.(event);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (shouldTriggerClick &amp;&amp; !isTriggeredRef.<span class=\"property\">current</span> &amp;&amp; onClickRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          onClickRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">const</span> <span class=\"title function_\">onEndWithClick</span> = (<span class=\"params\">event: EventType</span>) =&gt; <span class=\"title function_\">onEnd</span>(event, <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">          isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">          targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    [],</span><br><span class=\"line\">    target,</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>先忽略种种细节，useLongPress这个函数接收三个参数：</p>\n<ol>\n<li>onLongPress，顾名思义，触发长按事件的回调函数。</li>\n<li>target：可以是dom元素，也可以是存储dom元素的ref。</li>\n<li>第三个参数是个对象，有四个子参数：delay(长按多长时间以后触发长按事件，也就是触发长按事件的时间)、moveThreshold（在长按的过程中鼠标或者手指如果有移动，并且这个值存在，会根据这个参数的值决定是否响应长按事件）、onClick(如果有这个值，并且鼠标或者手指按压结束，并且按压时间小于delay，会调用onClick函数)、onLongPressEnd(如果按压结束已经触发过长按事件，在真正结束的时候如果有这个值会调用onLongPressEnd函数)。</li>\n</ol>\n<p>代码开头那个useEffectWithTarget先认为就是useEffect，先忽略useEffectWithTarget大多数代码，直接看这几句：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">    targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">        isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!touchSupported) &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousedown&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseup&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mouseleave&#x27;</span>, onEnd);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;mousemove&#x27;</span>, onMove);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchstart&#x27;</span>, onStart);</span><br><span class=\"line\">        targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchend&#x27;</span>, onEndWithClick);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hasMoveThreshold) targetElement.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&#x27;touchmove&#x27;</span>, onMove);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>根据是否支持触摸事件，分别监听鼠标或者touch事件，响应的事件很有规律，只不过鼠标事件多了个mouseleave，这里我觉得touch事件也应该加个对应的，比如touchcancel。</p>\n<p>onStart</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span> = (<span class=\"params\">event: EventType</span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hasMoveThreshold) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> &#123;clientX, clientY&#125; = <span class=\"title function_\">getClientPosition</span>(event);</span><br><span class=\"line\">        pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">x</span> = clientX;</span><br><span class=\"line\">        pervPositionRef.<span class=\"property\">current</span>.<span class=\"property\">y</span> = clientY;</span><br><span class=\"line\">    &#125; <span class=\"comment\">// 假设没有moveThreshold，这一句先忽略</span></span><br><span class=\"line\">    timerRef.<span class=\"property\">current</span> = <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        onLongPressRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">        isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;, delay); <span class=\"comment\">//delay秒后执行onLongPressRef.current，isTriggeredRef.current表示是否执行过onLongPress</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>onEndWithClick</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onEndWithClick</span> = (<span class=\"params\">event: EventType</span>) =&gt; <span class=\"title function_\">onEnd</span>(event, <span class=\"literal\">true</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span> = (<span class=\"params\">event: EventType, shouldTriggerClick: boolean = <span class=\"literal\">false</span></span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">clearTimeout</span>(timerRef.<span class=\"property\">current</span>); <span class=\"comment\">//鼠标抬起或者触摸结束时，如果onLongPress还没有调用，清除定时器</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isTriggeredRef.<span class=\"property\">current</span>) &#123; <span class=\"comment\">//如果onLongPress已经被调用过了，调用onLongPressEnd（如果有）</span></span><br><span class=\"line\">        onLongPressEndRef.<span class=\"property\">current</span>?.(event);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (shouldTriggerClick &amp;&amp; !isTriggeredRef.<span class=\"property\">current</span> &amp;&amp; onClickRef.<span class=\"property\">current</span>) &#123; </span><br><span class=\"line\">        onClickRef.<span class=\"title function_\">current</span>(event);</span><br><span class=\"line\">    &#125; <span class=\"comment\">// 这里的shouldTriggerClick为true，如果onLongPress还没有被触发并且有onClick，调用onClick</span></span><br><span class=\"line\">    isTriggeredRef.<span class=\"property\">current</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>onStart与onEndWithClick其实就是onLongPress函数的核心。有时候按压的时候会移动，这时候是否触发longpress事件，这种情况就需要传moveThreshold。</p>\n<p>这个值是个对象{x:0,y:0}，如果按压的过程中有移动，移动的距离(x&#x2F;y)大于moveThreshold.x或者moveThreshold.y，就会取消响应longPress。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span> = (<span class=\"params\">event: TouchEvent</span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timerRef.<span class=\"property\">current</span> &amp;&amp; <span class=\"title function_\">overThreshold</span>(event)) &#123; <span class=\"comment\">//移动的时候还没有响应longPress，并且移动的距离超了，就会取消定时器</span></span><br><span class=\"line\">        <span class=\"built_in\">clearInterval</span>(timerRef.<span class=\"property\">current</span>);</span><br><span class=\"line\">        timerRef.<span class=\"property\">current</span> = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>以上就是useLongPress的主要内容。</p>\n<h2 id=\"useEffectWithTarget\"><a href=\"#useEffectWithTarget\" class=\"headerlink\" title=\"useEffectWithTarget\"></a>useEffectWithTarget</h2><p>这里顺便提一下这个hook，代码在<a href=\"https://github.com/alibaba/hooks/blob/master/packages/hooks/src/utils/createEffectWithTarget.ts\">这里</a>，看起来功能和useEffect差不多，只不过多了对前后dom元素的对比，<a href=\"https://github.com/alibaba/hooks/blob/master/packages/hooks/src/utils/createEffectWithTarget.ts#L42\">代码</a>，参数也由useEffect的两个变成了三个。我觉得这个hook的意义更多的在于代码的可读性，由于第三个参数的存在，可以明确表示这个hook是与哪个dom元素相关联。</p>\n","categories":[],"tags":[]}